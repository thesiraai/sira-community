version: '3.8'

# SIRA Community Production Docker Compose Configuration
# Production-grade configuration with infrastructure integration
# Uses shared infrastructure services (PostgreSQL, Redis) via sira_infra_network
# Requires SSL client certificates for database connections (mTLS)

services:
  # Main Application
  app:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: sira-community-app
    # Entrypoint must run as root to copy certificates from read-only mounts
    # The entrypoint script will switch to community user after copying
    user: root
    environment:
      RAILS_ENV: production
      # Application root directory (required by Puma config)
      APP_ROOT: /var/www/community
      # Database Configuration (Community PostgreSQL)
      # Use service name: postgres-community (per infrastructure team guidance)
      DISCOURSE_DB_HOST: postgres-community
      DISCOURSE_DB_PORT: ${POSTGRES_PORT:-5432}
      DISCOURSE_DB_NAME: sira_community
      DISCOURSE_DB_USERNAME: sira_community_user
      DISCOURSE_DB_PASSWORD: community_app_password_2025
      DISCOURSE_DB_POOL: ${COMMUNITY_DB_POOL:-8}
      # PostgreSQL SSL Configuration (mTLS - REQUIRED for community postgres)
      # Certificates are copied by entrypoint to /var/www/community/tmp/ssl/ (writable location)
      # Per infrastructure team: certificates at /opt/sira-ai/ssl/postgres-community/ (read-only mount)
      POSTGRES_SSL_MODE: require
      POSTGRES_SSL_CERT: /var/www/community/tmp/ssl/postgres-client.crt
      POSTGRES_SSL_KEY: /var/www/community/tmp/ssl/postgres-client.key
      POSTGRES_SSL_CA: /var/www/community/tmp/ssl/ca.crt
      POSTGRES_CA_FILE: /var/www/community/tmp/ssl/ca.crt
      POSTGRES_CLIENT_CERT: /var/www/community/tmp/ssl/postgres-client.crt
      POSTGRES_CLIENT_KEY: /var/www/community/tmp/ssl/postgres-client.key
      # Redis Configuration (Infrastructure Redis with TLS)
      DISCOURSE_REDIS_HOST: ${REDIS_HOST:-redis}
      DISCOURSE_REDIS_PORT: ${REDIS_PORT:-6380}
      DISCOURSE_REDIS_PASSWORD: ${REDIS_PASSWORD}
      DISCOURSE_REDIS_DB: ${COMMUNITY_REDIS_DB:-0}
      # Redis SSL Configuration (TLS - MANDATORY for port 6380)
      REDIS_SSL: "true"
      REDIS_TLS: "true"
      # Certificate paths point to writable location (copied by entrypoint)
      REDIS_SSL_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_SSL_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_SSL_CA: /var/www/community/tmp/ssl/ca.crt
      REDIS_CA_FILE: /var/www/community/tmp/ssl/ca.crt
      REDIS_CLIENT_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_CLIENT_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_TLS_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_TLS_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_TLS_CA: /var/www/community/tmp/ssl/ca.crt
      # Application Configuration
      DISCOURSE_HOSTNAME: ${COMMUNITY_HOSTNAME:-community.sira.ai}
      DISCOURSE_SECRET_KEY_BASE: ${COMMUNITY_SECRET_KEY_BASE}
      # SMTP Configuration
      DISCOURSE_SMTP_ADDRESS: ${COMMUNITY_SMTP_ADDRESS}
      DISCOURSE_SMTP_PORT: ${COMMUNITY_SMTP_PORT:-587}
      DISCOURSE_SMTP_USER_NAME: ${COMMUNITY_SMTP_USER_NAME}
      DISCOURSE_SMTP_PASSWORD: ${COMMUNITY_SMTP_PASSWORD}
      DISCOURSE_SMTP_DOMAIN: ${COMMUNITY_SMTP_DOMAIN}
      DISCOURSE_SMTP_ENABLE_START_TLS: ${COMMUNITY_SMTP_ENABLE_START_TLS:-true}
      # SIRA Integration
      SIRA_API_URL: ${SIRA_API_URL:-https://api.sira.ai}
      SIRA_API_KEY: ${SIRA_API_KEY:-}
      # Performance
      UNICORN_WORKERS: ${COMMUNITY_WORKERS:-4}
      # Logging
      RAILS_LOG_TO_STDOUT: "true"
      LOG_LEVEL: ${COMMUNITY_LOG_LEVEL:-info}
      # SSL Certificate Paths
      SSL_CERTS_DIR: /opt/sira-ai/ssl
      SSL_CA_PATH: /opt/sira-ai/ssl/ca/ca.crt
      NODE_EXTRA_CA_CERTS: /opt/sira-ai/ssl/ca/ca.crt
    volumes:
      - ../config/discourse.conf:/var/www/community/config/discourse.conf:ro
      - ../public/uploads:/var/www/community/public/uploads
      - ../public/backups:/var/www/community/public/backups
      - ../log:/var/www/community/log
      - ../tmp:/var/www/community/tmp
      # Mount SSL certificates (read-only)
      # Windows path: C:\Users\vvssi\OneDrive\Projects\AI Project\SIRA AI\Certs\sira-ca
      # Mount CA from server, community-specific certs from sira-community folder
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/server/ca:/opt/sira-ai/ssl/ca:ro"
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/sira-community/postgres:/opt/sira-ai/ssl/postgres-community:ro"
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/sira-community/redis:/opt/sira-ai/ssl/redis:ro"
    networks:
      - sira_infra_network
    # No external port exposure - accessed via nginx only
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/srv/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Background Jobs (Sidekiq)
  sidekiq:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: sira-community-sidekiq
    depends_on:
      app:
        condition: service_started
    environment:
      RAILS_ENV: production
      # Database Configuration (Community PostgreSQL)
      # Use service name: postgres-community (per infrastructure team guidance)
      DISCOURSE_DB_HOST: postgres-community
      DISCOURSE_DB_PORT: ${POSTGRES_PORT:-5432}
      DISCOURSE_DB_NAME: sira_community
      DISCOURSE_DB_USERNAME: sira_community_user
      DISCOURSE_DB_PASSWORD: community_app_password_2025
      # PostgreSQL SSL Configuration (mTLS - REQUIRED for community postgres)
      # Certificates are copied by entrypoint to /var/www/community/tmp/ssl/ (writable location)
      # Per infrastructure team: certificates at /opt/sira-ai/ssl/postgres-community/ (read-only mount)
      POSTGRES_SSL_MODE: require
      POSTGRES_SSL_CERT: /var/www/community/tmp/ssl/postgres-client.crt
      POSTGRES_SSL_KEY: /var/www/community/tmp/ssl/postgres-client.key
      POSTGRES_SSL_CA: /var/www/community/tmp/ssl/ca.crt
      POSTGRES_CA_FILE: /var/www/community/tmp/ssl/ca.crt
      POSTGRES_CLIENT_CERT: /var/www/community/tmp/ssl/postgres-client.crt
      POSTGRES_CLIENT_KEY: /var/www/community/tmp/ssl/postgres-client.key
      # Redis Configuration (Infrastructure Redis with TLS)
      DISCOURSE_REDIS_HOST: ${REDIS_HOST:-redis}
      DISCOURSE_REDIS_PORT: ${REDIS_PORT:-6380}
      DISCOURSE_REDIS_PASSWORD: ${REDIS_PASSWORD}
      DISCOURSE_REDIS_DB: ${COMMUNITY_REDIS_DB:-0}
      # Redis SSL Configuration (TLS - MANDATORY for port 6380)
      REDIS_SSL: "true"
      REDIS_TLS: "true"
      # Certificate paths point to writable location (copied by entrypoint)
      REDIS_SSL_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_SSL_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_SSL_CA: /var/www/community/tmp/ssl/ca.crt
      REDIS_CA_FILE: /var/www/community/tmp/ssl/ca.crt
      REDIS_CLIENT_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_CLIENT_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_TLS_CERT: /var/www/community/tmp/ssl/redis-client.crt
      REDIS_TLS_KEY: /var/www/community/tmp/ssl/redis-client.key
      REDIS_TLS_CA: /var/www/community/tmp/ssl/ca.crt
      # Application Configuration
      DISCOURSE_HOSTNAME: ${COMMUNITY_HOSTNAME:-community.sira.ai}
      DISCOURSE_SECRET_KEY_BASE: ${COMMUNITY_SECRET_KEY_BASE}
      # Logging
      RAILS_LOG_TO_STDOUT: "true"
      LOG_LEVEL: ${COMMUNITY_LOG_LEVEL:-info}
      # SSL Certificate Paths
      SSL_CERTS_DIR: /opt/sira-ai/ssl
      SSL_CA_PATH: /opt/sira-ai/ssl/ca/ca.crt
      NODE_EXTRA_CA_CERTS: /opt/sira-ai/ssl/ca/ca.crt
    volumes:
      - ../config/discourse.conf:/var/www/community/config/discourse.conf:ro
      - ../log:/var/www/community/log
      - ../tmp:/var/www/community/tmp
      # Mount SSL certificates (read-only)
      # Windows path: C:\Users\vvssi\OneDrive\Projects\AI Project\SIRA AI\Certs\sira-ca
      # Mount CA from server, community-specific certs from sira-community folder
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/server/ca:/opt/sira-ai/ssl/ca:ro"
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/sira-community/postgres:/opt/sira-ai/ssl/postgres-community:ro"
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/sira-community/redis:/opt/sira-ai/ssl/redis:ro"
    networks:
      - sira_infra_network
    command: bundle exec sidekiq -c ${COMMUNITY_SIDEKIQ_CONCURRENCY:-5}
    restart: unless-stopped
    healthcheck:
      # Sidekiq doesn't run a web server, so check if the process is running
      # Check if the main process command line contains "sidekiq"
      test: ["CMD-SHELL", "cat /proc/1/cmdline | grep -q sidekiq || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: sira-community-nginx
    depends_on:
      - app
    ports:
      - "${COMMUNITY_HTTP_PORT:-80}:80"
      - "${COMMUNITY_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - "${SSL_CERTS_PATH:-C:/Users/vvssi/OneDrive/Projects/AI Project/SIRA AI/Certs/sira-ca}/server/nginx-community:/etc/nginx/ssl:ro"
      - ../public:/var/www/community/public:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - sira_infra_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  sira_infra_network:
    name: sira_infra_network
    external: true



